name: SafeW - RSSç›‘å¬+å»é‡æ¨é€
on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  rss-push:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…Pythonä¾èµ–
        run: pip install --upgrade requests feedparser

      - name: æ‰§è¡ŒRSSç›‘å¬+å»é‡æ¨é€è„šæœ¬
        env:
          SAFEW_BOT_TOKEN: ${{ secrets.SAFEW_BOT_TOKEN }}
          SAFEW_CHAT_ID: ${{ secrets.SAFEW_CHAT_ID }}
          RSS_GITHUB_PAT: ${{ secrets.RSS_GITHUB_PAT }}
          GITHUB_REPO: ${{ github.repository }}
          STORE_ISSUE_TITLE: "å·²æ¨é€RSSé“¾æ¥è®°å½•"
          RSS_FEED_URL: ${{ secrets.RSS_FEED_URL }}
        run: |
          # å¼ºåˆ¶è¾“å‡ºæ‰€æœ‰æ—¥å¿—ï¼Œé¿å…ç¼“å†²å¯¼è‡´ä¿¡æ¯ä¸¢å¤±
          python - <<END | tee -a workflow.log
          import os
          import requests
          import feedparser
          import traceback
          import sys  # æ–°å¢ï¼šç¡®ä¿æ—¥å¿—è¾“å‡ºåˆ°stdout
          from datetime import datetime

          # ç¡®ä¿æ‰€æœ‰æ‰“å°ç«‹å³è¾“å‡º
          sys.stdout.flush()

          # -------------------------- ç¯å¢ƒå˜é‡æ ¡éªŒï¼ˆç»ˆæç‰ˆï¼‰ --------------------------
          print("===== å¼€å§‹ç¯å¢ƒå˜é‡æ ¡éªŒ =====")
          required_vars = [
              'SAFEW_BOT_TOKEN', 'SAFEW_CHAT_ID', 
              'RSS_GITHUB_PAT', 'RSS_FEED_URL'
          ]
          for var in required_vars:
              value = os.getenv(var)
              if not value or not value.strip():
                  print(f'âŒ ä¸¥é‡é”™è¯¯ï¼šç¯å¢ƒå˜é‡ã€{var}ã€‘ç¼ºå¤±æˆ–ä¸ºç©ºï¼')
                  exit(1)
              else:
                  print(f'âœ… ç¯å¢ƒå˜é‡ã€{var}ã€‘å­˜åœ¨ï¼ˆå€¼é•¿åº¦ï¼š{len(value.strip())}ï¼‰')

          # è¯»å–å¹¶æ¸…ç†ç¯å¢ƒå˜é‡
          safew_bot_token = os.getenv('SAFEW_BOT_TOKEN').strip()
          safew_chat_id = os.getenv('SAFEW_CHAT_ID').strip()
          github_pat = os.getenv('RSS_GITHUB_PAT').strip()
          github_repo = os.getenv('GITHUB_REPO').strip()
          store_issue_title = os.getenv('STORE_ISSUE_TITLE').strip()
          rss_feed_url = os.getenv('RSS_FEED_URL').strip()

          # æ ¡éªŒURLæ ¼å¼
          if not rss_feed_url.startswith(('http://', 'https://')):
              print(f'âŒ ä¸¥é‡é”™è¯¯ï¼šRSS_FEED_URLã€{rss_feed_url}ã€‘å¿…é¡»ä»¥http/httpså¼€å¤´ï¼')
              exit(1)
          print(f'âœ… RSS_FEED_URLæ ¼å¼æ ¡éªŒé€šè¿‡ï¼š{rss_feed_url}')

          github_headers = {
              'Authorization': 'token ' + github_pat,
              'Accept': 'application/vnd.github.v3+json'
          }
          print("===== ç¯å¢ƒå˜é‡æ ¡éªŒé€šè¿‡ =====")
          sys.stdout.flush()

          # -------------------------- è§£æRSSæº --------------------------
          def parse_rss():
              try:
                  print("\n===== å¼€å§‹è§£æRSS =====")
                  print(f'è¯·æ±‚URLï¼š{rss_feed_url}')
                  feed = feedparser.parse(rss_feed_url)
                  if feed.bozo != 0:
                      print(f'âŒ RSSè§£æé”™è¯¯ï¼ˆæ ¼å¼é—®é¢˜ï¼‰ï¼š{str(feed.bozo_exception)}')
                      return []
                  entries = []
                  for entry in feed.entries[:3]:  # åªè§£æå‰3æ¡ï¼Œå‡å°‘æ•°æ®é‡
                      entries.append({
                          'title': entry.get('title', 'æ— æ ‡é¢˜'),
                          'link': entry.get('link', ''),
                          'summary': entry.get('summary', 'æ— æ‘˜è¦')[:50] + '...',
                          'published': entry.get('published', 'æœªçŸ¥æ—¶é—´')
                      })
                  print(f'âœ… è§£æå®Œæˆï¼Œè·å–{len(entries)}æ¡æ¡ç›®')
                  sys.stdout.flush()
                  return entries
              except Exception as e:
                  print(f'âŒ RSSè§£æå¤±è´¥ï¼ˆç½‘ç»œ/å…¶ä»–é—®é¢˜ï¼‰ï¼š')
                  traceback.print_exc()
                  sys.stdout.flush()
                  return []

          # -------------------------- è¯»å–å·²æ¨é€é“¾æ¥ --------------------------
          def get_pushed_links():
              try:
                  print("\n===== å¼€å§‹è¯»å–å·²æ¨é€é“¾æ¥ =====")
                  search_url = f'https://api.github.com/search/issues?q=repo:{github_repo}+title:"{store_issue_title}"+state:open'
                  print(f'æœç´¢Issue URLï¼š{search_url}')
                  response = requests.get(search_url, headers=github_headers, timeout=20)
                  print(f'GitHubæœç´¢å“åº”çŠ¶æ€ç ï¼š{response.status_code}')
                  response.raise_for_status()
                  
                  search_result = response.json()
                  print(f'æœç´¢ç»“æœï¼š{search_result.get("total_count")}ä¸ªIssue')
                  
                  if search_result['total_count'] == 0:
                      print(f'åˆ›å»ºæ–°Issue...')
                      create_url = f'https://api.github.com/repos/{github_repo}/issues'
                      create_resp = requests.post(create_url, headers=github_headers, json={
                          'title': store_issue_title,
                          'body': 'åˆå§‹å†…å®¹',
                          'labels': ['rss-store']
                      }, timeout=20)
                      print(f'åˆ›å»ºIssueå“åº”çŠ¶æ€ç ï¼š{create_resp.status_code}')
                      create_resp.raise_for_status()
                      issue_id = create_resp.json()['number']
                      print(f'âœ… æ–°Issue IDï¼š{issue_id}')
                      return set(), issue_id
                  
                  store_issue_id = search_result['items'][0]['number']
                  print(f'æ‰¾åˆ°å·²æœ‰Issue IDï¼š{store_issue_id}')
                  issue_resp = requests.get(
                      f'https://api.github.com/repos/{github_repo}/issues/{store_issue_id}',
                      headers=github_headers,
                      timeout=20
                  )
                  print(f'è¯»å–Issueå“åº”çŠ¶æ€ç ï¼š{issue_resp.status_code}')
                  issue_resp.raise_for_status()
                  
                  pushed_links = set()
                  for line in issue_resp.json()['body'].split('\n')[:5]:  # åªè¯»å‰5è¡Œ
                      if line.strip().startswith('http'):
                          pushed_links.add(line.strip())
                  print(f'âœ… å·²æ¨é€é“¾æ¥æ•°é‡ï¼š{len(pushed_links)}')
                  sys.stdout.flush()
                  return pushed_links, store_issue_id
              
              except Exception as e:
                  print(f'âŒ è¯»å–å·²æ¨é€é“¾æ¥å¤±è´¥ï¼š')
                  traceback.print_exc()
                  sys.stdout.flush()
                  return set(), None

          # -------------------------- æ¨é€æ¶ˆæ¯åˆ°SafeW --------------------------
          def push_to_safew(entry):
              try:
                  print("\n===== å¼€å§‹æ¨é€æ¶ˆæ¯ =====")
                  def escape(s):
                      for c in '_*~`>#+-.!()':
                          s = s.replace(c, '\\' + c)
                      return s
                  
                  msg = f'ğŸ”” æ–°å†…å®¹ï¼š{escape(entry["title"])[:20]}\né“¾æ¥ï¼š{escape(entry["link"])[:30]}'
                  print(f'å¾…æ¨é€æ¶ˆæ¯ï¼š{msg}')
                  
                  api_url = f'https://api.safew.org/bot{safew_bot_token}/sendMessage'
                  print(f'SafeW API URLï¼š{api_url}')
                  print(f'Chat IDï¼š{safew_chat_id}')
                  
                  response = requests.post(api_url, params={
                      'chat_id': safew_chat_id,
                      'text': msg,
                      'parse_mode': 'Markdown'
                  }, timeout=20)
                  print(f'SafeWå“åº”çŠ¶æ€ç ï¼š{response.status_code}')
                  response.raise_for_status()
                  print(f'âœ… æ¨é€æˆåŠŸ')
                  sys.stdout.flush()
                  return True
              
              except Exception as e:
                  print(f'âŒ æ¨é€æ¶ˆæ¯å¤±è´¥ï¼š')
                  traceback.print_exc()
                  sys.stdout.flush()
                  return False

          # -------------------------- ä¸»å‡½æ•° --------------------------
          def main():
              try:
                  print("===== ç¨‹åºå¼€å§‹è¿è¡Œ =====")
                  entries = parse_rss()
                  if not entries:
                      print("===== æ— RSSæ¡ç›®ï¼Œæ­£å¸¸ç»“æŸ =====")
                      return
                  
                  pushed_links, issue_id = get_pushed_links()
                  if issue_id is None:
                      print("===== æ— æ³•è·å–å­˜å‚¨Issueï¼Œç»“æŸ =====")
                      return
                  
                  new_entries = [e for e in entries if e['link'] not in pushed_links and e['link']]
                  if not new_entries:
                      print("===== æ— æ–°å†…å®¹ï¼Œæ­£å¸¸ç»“æŸ =====")
                      return
                  print(f'å¾…æ¨é€æ–°æ¡ç›®æ•°é‡ï¼š{len(new_entries)}')
                  
                  for entry in new_entries[:1]:  # åªæ¨1æ¡æµ‹è¯•
                      push_to_safew(entry)
                  
                  print("===== ç¨‹åºæ‰§è¡Œå®Œæˆ =====")
              
              except Exception as e:
                  print(f'âŒ ä¸»ç¨‹åºæœ€ç»ˆå¼‚å¸¸ï¼š')
                  traceback.print_exc()
                  sys.stdout.flush()
                  exit(1)

          if __name__ == '__main__':
              main()
              print("===== ç¨‹åºæ­£å¸¸é€€å‡º =====")
          END
          # è¾“å‡ºæ—¥å¿—æ–‡ä»¶å†…å®¹ï¼ˆç¡®ä¿æ‰€æœ‰æ—¥å¿—è¢«æ•è·ï¼‰
          cat workflow.log
