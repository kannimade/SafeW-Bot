name: SafeW - RSSç›‘å¬+å»é‡æ¨é€
on:
  schedule:
    - cron: '*/1 * * * *'
  workflow_dispatch:

jobs:
  rss-push:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…Pythonä¾èµ–
        run: pip install --upgrade requests feedparser

      - name: æ‰§è¡ŒRSSç›‘å¬+å»é‡æ¨é€è„šæœ¬
        env:
          SAFEW_BOT_TOKEN: ${{ secrets.SAFEW_BOT_TOKEN }}
          SAFEW_CHAT_ID: ${{ secrets.SAFEW_CHAT_ID }}
          RSS_GITHUB_PAT: ${{ secrets.RSS_GITHUB_PAT }}
          GITHUB_REPO: ${{ github.repository }}
          STORE_ISSUE_TITLE: "å·²æ¨é€RSSé“¾æ¥è®°å½•"
          RSS_FEED_URL: ${{ secrets.RSS_FEED_URL }}
        run: |
          python - <<END
          import os
          import requests
          import feedparser
          from datetime import datetime

          # -------------------------- å…³é”®ï¼šç¯å¢ƒå˜é‡æ ¡éªŒ --------------------------
          required_vars = [
              'SAFEW_BOT_TOKEN', 'SAFEW_CHAT_ID', 
              'RSS_GITHUB_PAT', 'RSS_FEED_URL'
          ]
          missing_vars = [var for var in required_vars if not os.getenv(var)]
          if missing_vars:
              print(f'âŒ é”™è¯¯ï¼šç¼ºå¤±å¿…è¦ç¯å¢ƒå˜é‡ï¼š{missing_vars}')
              exit(1)  # æ˜ç¡®é€€å‡ºï¼Œé¿å…åç»­é”™è¯¯

          # è¯»å–ç¯å¢ƒå˜é‡ï¼ˆæ ¡éªŒåç¡®ä¿å­˜åœ¨ï¼‰
          safew_bot_token = os.getenv('SAFEW_BOT_TOKEN')
          safew_chat_id = os.getenv('SAFEW_CHAT_ID')
          github_pat = os.getenv('RSS_GITHUB_PAT')
          github_repo = os.getenv('GITHUB_REPO')
          store_issue_title = os.getenv('STORE_ISSUE_TITLE')
          rss_feed_url = os.getenv('RSS_FEED_URL')

          github_headers = {
              'Authorization': 'token ' + github_pat,
              'Accept': 'application/vnd.github.v3+json'
          }

          # -------------------------- è§£æRSSæº --------------------------
          def parse_rss():
              try:
                  print(f'ğŸ” å¼€å§‹è§£æRSSæºï¼š{rss_feed_url}')
                  feed = feedparser.parse(rss_feed_url)
                  if feed.bozo != 0:
                      error_msg = f'RSSè§£æå¤±è´¥ï¼ˆæ ¼å¼é”™è¯¯ï¼‰ï¼š{str(feed.bozo_exception)}'
                      print(f'âŒ {error_msg}')
                      return []
                  entries = []
                  for entry in feed.entries:
                      entries.append({
                          'title': entry.get('title', 'æ— æ ‡é¢˜'),
                          'link': entry.get('link', ''),
                          'summary': entry.get('summary', 'æ— æ‘˜è¦')[:150] + '...' if len(entry.get('summary', '')) > 150 else entry.get('summary', 'æ— æ‘˜è¦'),
                          'published': entry.get('published', datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
                      })
                  print(f'âœ… æˆåŠŸè§£æåˆ°{len(entries)}æ¡RSSæ¡ç›®')
                  return entries
              except Exception as e:
                  print(f'âŒ RSSè§£æå¼‚å¸¸ï¼ˆç½‘ç»œæˆ–å…¶ä»–é”™è¯¯ï¼‰ï¼š{str(e)}')
                  return []

          # -------------------------- è¯»å–å·²æ¨é€é“¾æ¥ --------------------------
          def get_pushed_links():
              try:
                  search_url = 'https://api.github.com/search/issues?q=repo:' + github_repo + '+title:"' + store_issue_title + '"+state:open'
                  print(f'ğŸ” æœç´¢å­˜å‚¨Issueï¼š{search_url}')
                  response = requests.get(search_url, headers=github_headers, timeout=10)
                  response.raise_for_status()  # è§¦å‘HTTPé”™è¯¯ï¼ˆå¦‚404ã€403ï¼‰
                  
                  search_result = response.json()
                  if search_result['total_count'] == 0:
                      print(f'ğŸ“ æœªæ‰¾åˆ°å­˜å‚¨Issueï¼Œåˆ›å»ºæ–°çš„...')
                      create_url = 'https://api.github.com/repos/' + github_repo + '/issues'
                      create_resp = requests.post(create_url, headers=github_headers, json={
                          'title': store_issue_title,
                          'body': '# å·²æ¨é€RSSé“¾æ¥è®°å½•\n\nä»¥ä¸‹ä¸ºå·²æ¨é€çš„é“¾æ¥ï¼Œæ¯è¡Œä¸€ä¸ªï¼š\n',
                          'labels': ['rss-store']
                      }, timeout=10)
                      create_resp.raise_for_status()
                      issue_id = create_resp.json()['number']
                      print(f'âœ… å­˜å‚¨Issueåˆ›å»ºæˆåŠŸï¼ˆIDï¼š{issue_id}ï¼‰')
                      return set(), issue_id
                  
                  store_issue_id = search_result['items'][0]['number']
                  print(f'ğŸ“ æ‰¾åˆ°å­˜å‚¨Issueï¼ˆIDï¼š{store_issue_id}ï¼‰ï¼Œè¯»å–å†…å®¹...')
                  issue_resp = requests.get(
                      'https://api.github.com/repos/' + github_repo + '/issues/' + str(store_issue_id),
                      headers=github_headers,
                      timeout=10
                  )
                  issue_resp.raise_for_status()
                  
                  pushed_links = set()
                  for line in issue_resp.json()['body'].split('\n'):
                      if line.strip().startswith('http'):
                          pushed_links.add(line.strip())
                  print(f'âœ… è¯»å–åˆ°{len(pushed_links)}æ¡å·²æ¨é€é“¾æ¥')
                  return pushed_links, store_issue_id
              
              except requests.exceptions.HTTPError as e:
                  print(f'âŒ GitHub APIè¯·æ±‚å¤±è´¥ï¼š{str(e)}ï¼ˆå¯èƒ½æ˜¯PATæƒé™ä¸è¶³æˆ–ä»“åº“ä¸å­˜åœ¨ï¼‰')
                  return set(), None
              except Exception as e:
                  print(f'âŒ è¯»å–å·²æ¨é€é“¾æ¥å¼‚å¸¸ï¼š{str(e)}')
                  return set(), None

          # -------------------------- æ¨é€æ¶ˆæ¯åˆ°SafeW --------------------------
          def push_to_safew(entry):
              try:
                  def escape(s):
                      for c in '_*~`>#+-.!()':
                          s = s.replace(c, '\\' + c)
                      return s
                  
                  msg = 'ğŸ”” RSSæ–°å†…å®¹æé†’\n'
                  msg += '----------------\n'
                  msg += '**æ ‡é¢˜**ï¼š' + escape(entry['title']) + '\n'
                  msg += '**å‘å¸ƒæ—¶é—´**ï¼š' + entry['published'] + '\n'
                  msg += '**æ‘˜è¦**ï¼š' + escape(entry['summary']) + '\n'
                  msg += '**é“¾æ¥**ï¼š' + escape(entry['link'])
                  
                  api_url = 'https://api.safew.org/bot' + safew_bot_token + '/sendMessage'
                  print(f'ğŸ“¤ æ¨é€æ¶ˆæ¯åˆ°SafeWï¼š{entry["title"][:20]}...')
                  response = requests.post(api_url, params={
                      'chat_id': safew_chat_id,
                      'text': msg,
                      'parse_mode': 'Markdown',
                      'disable_web_page_preview': True
                  }, timeout=10)
                  response.raise_for_status()  # è§¦å‘HTTPé”™è¯¯ï¼ˆå¦‚401 Tokenæ— æ•ˆï¼‰
                  print(f'âœ… æ¨é€æˆåŠŸï¼š{entry["title"]}')
                  return True
              
              except requests.exceptions.HTTPError as e:
                  print(f'âŒ SafeWæ¨é€å¤±è´¥ï¼ˆHTTPé”™è¯¯ï¼‰ï¼š{str(e)}ï¼ˆå¯èƒ½æ˜¯Tokenæˆ–Chat IDé”™è¯¯ï¼‰')
                  return False
              except Exception as e:
                  print(f'âŒ æ¨é€æ¶ˆæ¯å¼‚å¸¸ï¼š{str(e)}')
                  return False

          # -------------------------- æ›´æ–°å·²æ¨é€é“¾æ¥ --------------------------
          def update_pushed_links(issue_id, new_links):
              if not new_links or not issue_id:
                  print('â„¹ï¸ æ— æ–°é“¾æ¥éœ€è¦æ›´æ–°å­˜å‚¨')
                  return
              
              try:
                  issue_url = 'https://api.github.com/repos/' + github_repo + '/issues/' + str(issue_id)
                  print(f'ğŸ“ æ›´æ–°å­˜å‚¨Issueï¼ˆIDï¼š{issue_id}ï¼‰ï¼Œæ–°å¢{len(new_links)}æ¡é“¾æ¥...')
                  issue_resp = requests.get(issue_url, headers=github_headers, timeout=10)
                  issue_resp.raise_for_status()
                  
                  updated_body = issue_resp.json()['body'] + '\n' + '\n'.join(new_links)
                  update_resp = requests.patch(issue_url, headers=github_headers, json={
                      'body': updated_body
                  }, timeout=10)
                  update_resp.raise_for_status()
                  print(f'âœ… å­˜å‚¨æ›´æ–°æˆåŠŸ')
              
              except requests.exceptions.HTTPError as e:
                  print(f'âŒ æ›´æ–°å­˜å‚¨å¤±è´¥ï¼ˆHTTPé”™è¯¯ï¼‰ï¼š{str(e)}')
              except Exception as e:
                  print(f'âŒ æ›´æ–°å­˜å‚¨å¼‚å¸¸ï¼š{str(e)}')

          # -------------------------- ä¸»å‡½æ•° --------------------------
          def main():
              try:
                  # 1. è§£æRSS
                  entries = parse_rss()
                  if not entries:
                      print('â„¹ï¸ æœªè·å–åˆ°RSSæ¡ç›®ï¼Œç»ˆæ­¢æ‰§è¡Œ')
                      return
                  
                  # 2. è¯»å–å·²æ¨é€é“¾æ¥
                  pushed_links, issue_id = get_pushed_links()
                  if issue_id is None:
                      print('âŒ æ— æ³•è·å–å­˜å‚¨Issue IDï¼Œç»ˆæ­¢æ‰§è¡Œ')
                      return
                  
                  # 3. ç­›é€‰æ–°æ¡ç›®
                  new_entries = [e for e in entries if e['link'] not in pushed_links and e['link']]
                  if not new_entries:
                      print('â„¹ï¸ æ— æ–°å†…å®¹å¯æ¨é€ï¼Œç»“æŸæ‰§è¡Œ')
                      return
                  print(f'ğŸ“‹ ç­›é€‰å‡º{len(new_entries)}æ¡æœªæ¨é€æ¡ç›®')
                  
                  # 4. æ¨é€å¹¶è®°å½•æˆåŠŸçš„é“¾æ¥
                  success_links = []
                  for entry in new_entries[:5]:  # å•æ¬¡æœ€å¤šæ¨5æ¡
                      if push_to_safew(entry):
                          success_links.append(entry['link'])
                  
                  # 5. æ›´æ–°å­˜å‚¨
                  if success_links:
                      update_pushed_links(issue_id, success_links)
                  else:
                      print('â„¹ï¸ æ— æˆåŠŸæ¨é€çš„é“¾æ¥ï¼Œæ— éœ€æ›´æ–°å­˜å‚¨')
              
              except Exception as e:
                  print(f'âŒ ä¸»ç¨‹åºå¼‚å¸¸ï¼š{str(e)}')
                  exit(1)  # æ˜ç¡®å¼‚å¸¸é€€å‡º

          if __name__ == '__main__':
              main()
              print('âœ… ç¨‹åºæ­£å¸¸ç»“æŸ')
          END
