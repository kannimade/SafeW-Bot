name: SafeW - RSSç›‘å¬+å»é‡æ¨é€
on:
  schedule:
    - cron: '*/5 * * * *'  # é™ä½é¢‘ç‡ï¼Œé¿å…æµ‹è¯•æ—¶é¢‘ç¹è§¦å‘
  workflow_dispatch:

jobs:
  rss-push:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…Pythonä¾èµ–
        run: pip install --upgrade requests feedparser

      - name: æ‰§è¡ŒRSSæ¨é€è„šæœ¬
        env:
          SAFEW_BOT_TOKEN: ${{ secrets.SAFEW_BOT_TOKEN }}
          SAFEW_CHAT_ID: ${{ secrets.SAFEW_CHAT_ID }}
          RSS_GITHUB_PAT: ${{ secrets.RSS_GITHUB_PAT }}
          GITHUB_REPO: ${{ github.repository }}
          RSS_FEED_URL: ${{ secrets.RSS_FEED_URL }}
        run: |
          # ç”¨heredocè¯­æ³•ï¼Œå½»åº•éš”ç¦»Pythonä»£ç ä¸Shellè§£æ
          python - <<'END'
          import os
          import requests
          import feedparser
          import traceback
          from datetime import datetime

          # -------------------------- 1. åŸºç¡€å‚æ•°åˆå§‹åŒ–ä¸æ ¡éªŒ --------------------------
          # è¯»å–ç¯å¢ƒå˜é‡ï¼ˆå¼ºåˆ¶å»é™¤å‰åç©ºæ ¼ï¼‰
          config = {
              "bot_token": os.getenv("SAFEW_BOT_TOKEN", "").strip(),
              "chat_id": os.getenv("SAFEW_CHAT_ID", "").strip(),
              "github_pat": os.getenv("RSS_GITHUB_PAT", "").strip(),
              "repo": os.getenv("GITHUB_REPO", "").strip(),
              "rss_url": os.getenv("RSS_FEED_URL", "").strip()
          }

          # æ ¡éªŒå¿…å¡«å‚æ•°
          missing = [k for k, v in config.items() if not v]
          if missing:
              print(f"âŒ ç¼ºå¤±å¿…å¡«å‚æ•°ï¼š{missing}")
              exit(1)

          # åˆå§‹åŒ–GitHubè¯·æ±‚å¤´
          github_headers = {
              "Authorization": f"token {config['github_pat']}",
              "Accept": "application/vnd.github.v3+json"
          }

          # -------------------------- 2. æ ¸å¿ƒå·¥å…·å‡½æ•° --------------------------
          def get_pushed_links():
              """ä»GitHub Issuesè¯»å–å·²æ¨é€é“¾æ¥ï¼Œè¿”å›ï¼ˆé“¾æ¥é›†åˆ, IssueIDï¼‰"""
              try:
                  # æœç´¢å­˜å‚¨ç”¨Issueï¼ˆæ ‡é¢˜å›ºå®šä¸º"RSSå·²æ¨é€è®°å½•"ï¼‰
                  search_url = f"https://api.github.com/search/issues?q=repo:{config['repo']}+title:RSSå·²æ¨é€è®°å½•+state:open"
                  resp = requests.get(search_url, headers=github_headers, timeout=15)
                  resp.raise_for_status()
                  search_res = resp.json()

                  # æ— Issueåˆ™åˆ›å»º
                  if search_res["total_count"] == 0:
                      create_url = f"https://api.github.com/repos/{config['repo']}/issues"
                      create_data = {
                          "title": "RSSå·²æ¨é€è®°å½•",
                          "body": "# RSSå·²æ¨é€é“¾æ¥è®°å½•\n\nä»¥ä¸‹ä¸ºå·²æ¨é€çš„é“¾æ¥ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰ï¼š\n",
                          "labels": ["rss-push"]
                      }
                      create_resp = requests.post(create_url, headers=github_headers, json=create_data, timeout=15)
                      create_resp.raise_for_status()
                      issue_id = create_resp.json()["number"]
                      print(f"âœ… é¦–æ¬¡è¿è¡Œï¼Œåˆ›å»ºå­˜å‚¨Issueï¼ˆIDï¼š{issue_id}ï¼‰")
                      return set(), issue_id

                  # æœ‰Issueåˆ™è¯»å–é“¾æ¥
                  issue_id = search_res["items"][0]["number"]
                  issue_url = f"https://api.github.com/repos/{config['repo']}/issues/{issue_id}"
                  issue_resp = requests.get(issue_url, headers=github_headers, timeout=15)
                  issue_resp.raise_for_status()

                  # æå–æ‰€æœ‰httpå¼€å¤´çš„é“¾æ¥
                  pushed_links = set()
                  for line in issue_resp.json()["body"].split("\n"):
                      line = line.strip()
                      if line.startswith(("http://", "https://")):
                          pushed_links.add(line)
                  print(f"âœ… è¯»å–åˆ°{len(pushed_links)}æ¡å·²æ¨é€é“¾æ¥")
                  return pushed_links, issue_id

              except Exception as e:
                  print("âŒ è¯»å–å·²æ¨é€é“¾æ¥å¤±è´¥ï¼š")
                  traceback.print_exc()
                  return set(), None

          def parse_rss_feed():
              """è§£æRSSæºï¼Œè¿”å›ï¼ˆæ ‡é¢˜, é“¾æ¥, å‘å¸ƒæ—¶é—´ï¼‰åˆ—è¡¨"""
              try:
                  print(f"ğŸ” å¼€å§‹è§£æRSSï¼š{config['rss_url']}")
                  feed = feedparser.parse(config["rss_url"])
                  if feed.bozo != 0:
                      print(f"âŒ RSSæ ¼å¼é”™è¯¯ï¼š{str(feed.bozo_exception)}")
                      return []

                  # æå–æ ¸å¿ƒä¿¡æ¯ï¼Œè¿‡æ»¤æ— é“¾æ¥æ¡ç›®
                  entries = []
                  for entry in feed.entries:
                      title = entry.get("title", "æ— æ ‡é¢˜")
                      link = entry.get("link", "")
                      published = entry.get("published", datetime.now().strftime("%Y-%m-%d %H:%M:%S"))
                      if link:  # åªä¿ç•™æœ‰é“¾æ¥çš„æ¡ç›®
                          entries.append((title, link, published))

                  print(f"âœ… è§£æå®Œæˆï¼Œå…±{len(entries)}æ¡æœ‰æ•ˆRSSæ¡ç›®")
                  return entries

              except Exception as e:
                  print("âŒ RSSè§£æå¤±è´¥ï¼š")
                  traceback.print_exc()
                  return []

          def push_to_group(title, link, published):
              """æ¨é€æ¶ˆæ¯åˆ°ç¾¤ç»„ï¼Œè¿”å›æ¨é€ç»“æœï¼ˆTrue/Falseï¼‰"""
              # 1. ç®€åŒ–æ¶ˆæ¯å†…å®¹ï¼Œé¿å…Markdownæ ¼å¼å†²çªï¼ˆå…ˆå…³é—­Markdownæµ‹è¯•ï¼‰
              msg = (
                  "ğŸ”” RSSæ–°å†…å®¹æé†’\n"
                  "----------------\n"
                  f"æ ‡é¢˜ï¼š{title}\n"
                  f"å‘å¸ƒæ—¶é—´ï¼š{published}\n"
                  f"é“¾æ¥ï¼š{link}"
              )

              # 2. æ„é€ æ¨é€è¯·æ±‚ï¼ˆé‡ç‚¹ï¼šç¡®è®¤APIåœ°å€æ˜¯å¦æ­£ç¡®ï¼‰
              # è‹¥SafeWåŸºäºTelegram APIï¼Œéœ€æ›¿æ¢ä¸ºï¼šhttps://api.telegram.org/bot{token}/sendMessage
              api_url = f"https://api.safew.org/bot{config['bot_token']}/sendMessage"
              params = {
                  "chat_id": config["chat_id"],
                  "text": msg,
                  "parse_mode": "None",  # å…ˆå…³é—­Markdownï¼Œæ’é™¤æ ¼å¼é—®é¢˜
                  "disable_web_page_preview": True
              }

              try:
                  print(f"ğŸ“¤ æ¨é€æ¶ˆæ¯ï¼š{title[:20]}...")
                  resp = requests.post(api_url, params=params, timeout=20)
                  print(f"ğŸ“¥ æ¨é€å“åº”çŠ¶æ€ç ï¼š{resp.status_code}")
                  print(f"ğŸ“¥ æ¨é€å“åº”å†…å®¹ï¼š{resp.text[:300]}")  # æ‰“å°éƒ¨åˆ†å“åº”ï¼Œä¾¿äºæ’æŸ¥
                  resp.raise_for_status()  # è§¦å‘HTTPé”™è¯¯ï¼ˆå¦‚401ã€400ï¼‰
                  print(f"âœ… æ¨é€æˆåŠŸï¼š{title}")
                  return True

              except Exception as e:
                  print(f"âŒ æ¨é€å¤±è´¥ï¼š{title}")
                  traceback.print_exc()
                  return False

          def update_pushed_records(issue_id, new_links):
              """æ›´æ–°GitHub Issueä¸­çš„å·²æ¨é€é“¾æ¥è®°å½•"""
              if not issue_id or not new_links:
                  return

              try:
                  issue_url = f"https://api.github.com/repos/{config['repo']}/issues/{issue_id}"
                  # è·å–å½“å‰Issueå†…å®¹
                  resp = requests.get(issue_url, headers=github_headers, timeout=15)
                  resp.raise_for_status()
                  current_body = resp.json()["body"]

                  # è¿½åŠ æ–°é“¾æ¥ï¼ˆæ¯è¡Œä¸€æ¡ï¼‰
                  new_content = current_body + "\n" + "\n".join(new_links)
                  # æ›´æ–°Issue
                  update_resp = requests.patch(
                      issue_url,
                      headers=github_headers,
                      json={"body": new_content},
                      timeout=15
                  )
                  update_resp.raise_for_status()
                  print(f"âœ… å·²æ›´æ–°æ¨é€è®°å½•ï¼Œæ–°å¢{len(new_links)}æ¡é“¾æ¥")

              except Exception as e:
                  print("âŒ æ›´æ–°æ¨é€è®°å½•å¤±è´¥ï¼š")
                  traceback.print_exc()

          # -------------------------- 3. ä¸»æµç¨‹ --------------------------
          def main():
              print("===== ç¨‹åºå¼€å§‹è¿è¡Œ =====")
              # æ­¥éª¤1ï¼šè§£æRSS
              rss_entries = parse_rss_feed()
              if not rss_entries:
                  print("===== æ— æœ‰æ•ˆRSSæ¡ç›®ï¼Œç¨‹åºç»“æŸ =====")
                  return

              # æ­¥éª¤2ï¼šè¯»å–å·²æ¨é€é“¾æ¥
              pushed_links, issue_id = get_pushed_links()
              if issue_id is None:
                  print("===== æ— æ³•è·å–å­˜å‚¨Issueï¼Œç¨‹åºç»“æŸ =====")
                  return

              # æ­¥éª¤3ï¼šç­›é€‰æœªæ¨é€æ¡ç›®
              new_entries = []
              for title, link, published in rss_entries:
                  if link not in pushed_links:
                      new_entries.append((title, link, published))

              if not new_entries:
                  print(f"===== æ— æ–°å†…å®¹å¯æ¨é€ï¼ˆå…±{len(rss_entries)}æ¡ï¼Œå‡å·²æ¨é€ï¼‰ï¼Œç¨‹åºç»“æŸ =====")
                  return
              print(f"âœ… ç­›é€‰å‡º{len(new_entries)}æ¡æœªæ¨é€æ¡ç›®")

              # æ­¥éª¤4ï¼šæ¨é€æ–°å†…å®¹ï¼ˆå•æ¬¡æœ€å¤šæ¨3æ¡ï¼Œé¿å…åˆ·å±ï¼‰
              success_links = []
              for title, link, published in new_entries[:3]:
                  if push_to_group(title, link, published):
                      success_links.append(link)

              # æ­¥éª¤5ï¼šæ›´æ–°æ¨é€è®°å½•
              if success_links:
                  update_pushed_records(issue_id, success_links)
              else:
                  print("â„¹ï¸ æ— æˆåŠŸæ¨é€çš„é“¾æ¥ï¼Œæ— éœ€æ›´æ–°è®°å½•")

              print("===== ç¨‹åºæ­£å¸¸ç»“æŸ =====")

          # -------------------------- 4. æ‰§è¡Œå…¥å£ --------------------------
          if __name__ == "__main__":
              try:
                  main()
              except Exception as e:
                  print("âŒ ç¨‹åºå¼‚å¸¸é€€å‡ºï¼š")
                  traceback.print_exc()
                  exit(1)
          END
