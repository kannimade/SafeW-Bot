name: SafeW - RSSç›‘å¬+å»é‡æ¨é€
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

jobs:
  rss-push:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…Pythonä¾èµ–
        run: pip install --upgrade requests feedparser

      - name: æ‰§è¡ŒRSSæ¨é€è„šæœ¬
        env:
          SAFEW_BOT_TOKEN: ${{ secrets.SAFEW_BOT_TOKEN }}
          SAFEW_CHAT_ID: ${{ secrets.SAFEW_CHAT_ID }}
          RSS_GITHUB_PAT: ${{ secrets.RSS_GITHUB_PAT }}
          GITHUB_REPO: ${{ github.repository }}
          STORE_ISSUE_TITLE: "å·²æ¨é€RSSé“¾æ¥è®°å½•"
          RSS_FEED_URL: ${{ secrets.RSS_FEED_URL }}
        run: |
          # å…³é”®ï¼šç”¨å•å¼•å·åŒ…è£¹heredocè¾¹ç•Œï¼ŒShellä¸è§£æå†…éƒ¨ä»»ä½•å­—ç¬¦
          python - <<'END'
          import os
          import requests
          import feedparser
          import traceback
          import sys
          from datetime import datetime

          # å¼ºåˆ¶æ—¥å¿—å®æ—¶è¾“å‡º
          sys.stdout.flush()

          # -------------------------- 1. ç¯å¢ƒå˜é‡æ ¡éªŒ --------------------------
          print("===== ç¯å¢ƒå˜é‡æ ¡éªŒ =====")
          required_vars = ['SAFEW_BOT_TOKEN', 'SAFEW_CHAT_ID', 'RSS_GITHUB_PAT', 'RSS_FEED_URL']
          config = {}
          for var in required_vars:
              val = os.getenv(var, '').strip()
              if not val:
                  print(f'âŒ ç¼ºå¤±å˜é‡ï¼š{var}')
                  exit(1)
              config[var] = val
              print(f'âœ… {var} å·²å°±ç»ªï¼ˆé•¿åº¦ï¼š{len(val)}ï¼‰')

          # è¡¥å……å…¶ä»–å˜é‡
          config['GITHUB_REPO'] = os.getenv('GITHUB_REPO', '').strip()
          config['STORE_ISSUE_TITLE'] = os.getenv('STORE_ISSUE_TITLE', '').strip()

          # æ ¡éªŒRSS URLæ ¼å¼
          if not config['RSS_FEED_URL'].startswith(('http://', 'https://')):
              print(f'âŒ RSS URLæ— æ•ˆï¼š{config["RSS_FEED_URL"]}')
              exit(1)
          print("===== ç¯å¢ƒå˜é‡æ ¡éªŒé€šè¿‡ =====")
          sys.stdout.flush()

          # -------------------------- 2. å·¥å…·å‡½æ•° --------------------------
          def parse_rss():
              """è§£æRSSæº"""
              try:
                  print(f"\n===== è§£æRSSï¼š{config['RSS_FEED_URL']} =====")
                  feed = feedparser.parse(config['RSS_FEED_URL'])
                  if feed.bozo != 0:
                      print(f'âŒ RSSæ ¼å¼é”™è¯¯ï¼š{str(feed.bozo_exception)[:100]}')
                      return []
                  entries = []
                  for entry in feed.entries[:3]:  # å–å‰3æ¡æµ‹è¯•
                      entries.append({
                          'title': entry.get('title', 'æ— æ ‡é¢˜'),
                          'link': entry.get('link', ''),
                          'published': entry.get('published', datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
                      })
                  print(f'âœ… è§£æåˆ°{len(entries)}æ¡æœ‰æ•ˆæ¡ç›®')
                  return entries
              except Exception as e:
                  print(f'âŒ RSSè§£æå¤±è´¥ï¼š')
                  traceback.print_exc()
                  return []

          def get_pushed_links():
              """è¯»å–å·²æ¨é€é“¾æ¥ï¼ˆGitHub Issuesï¼‰"""
              try:
                  print(f"\n===== è¯»å–å·²æ¨é€è®°å½• =====")
                  github_headers = {
                      'Authorization': f'token {config["RSS_GITHUB_PAT"]}',
                      'Accept': 'application/vnd.github.v3+json'
                  }
                  # æœç´¢Issue
                  search_url = f'https://api.github.com/search/issues?q=repo:{config["GITHUB_REPO"]}+title:"{config["STORE_ISSUE_TITLE"]}"+state:open'
                  resp = requests.get(search_url, headers=github_headers, timeout=20)
                  print(f'GitHubæœç´¢çŠ¶æ€ç ï¼š{resp.status_code}')
                  resp.raise_for_status()
                  search_res = resp.json()

                  # æ— Issueåˆ™åˆ›å»º
                  if search_res['total_count'] == 0:
                      print(f'åˆ›å»ºæ–°è®°å½•Issue...')
                      create_url = f'https://api.github.com/repos/{config["GITHUB_REPO"]}/issues'
                      create_resp = requests.post(create_url, headers=github_headers, json={
                          'title': config['STORE_ISSUE_TITLE'],
                          'body': '# å·²æ¨é€RSSé“¾æ¥\n\n',
                          'labels': ['rss-record']
                      }, timeout=20)
                      print(f'åˆ›å»ºçŠ¶æ€ç ï¼š{create_resp.status_code}')
                      create_resp.raise_for_status()
                      issue_id = create_resp.json()['number']
                      print(f'âœ… æ–°è®°å½•Issue IDï¼š{issue_id}')
                      return set(), issue_id

                  # æœ‰Issueåˆ™è¯»å–
                  issue_id = search_res['items'][0]['number']
                  issue_url = f'https://api.github.com/repos/{config["GITHUB_REPO"]}/issues/{issue_id}'
                  issue_resp = requests.get(issue_url, headers=github_headers, timeout=20)
                  print(f'è¯»å–è®°å½•çŠ¶æ€ç ï¼š{issue_resp.status_code}')
                  issue_resp.raise_for_status()

                  # æå–é“¾æ¥
                  pushed_links = set()
                  for line in issue_resp.json()['body'].split('\n'):
                      line = line.strip()
                      if line.startswith(('http://', 'https://')):
                          pushed_links.add(line)
                  print(f'âœ… å·²æ¨é€é“¾æ¥æ•°ï¼š{len(pushed_links)}')
                  return pushed_links, issue_id
              except Exception as e:
                  print(f'âŒ è¯»å–è®°å½•å¤±è´¥ï¼š')
                  traceback.print_exc()
                  return set(), None

          def push_to_safew(entry):
              """æ¨é€æ¶ˆæ¯ï¼ˆæ ¸å¿ƒä¿®æ­£ï¼šç§»é™¤åå¼•å·ï¼‰"""
              try:
                  print(f"\n===== æ¨é€æ¶ˆæ¯ =====")
                  # è½¬ä¹‰å‡½æ•°ï¼šå½»åº•ç§»é™¤åå¼•å·ï¼ˆ`ï¼‰ï¼Œé¿å…Shellè§£æ
                  def escape(s):
                      special_chars = r"_*~>#+-.!()"  # å…³é”®ï¼šæ— åå¼•å·
                      for c in special_chars:
                          s = s.replace(c, f'\\{c}')
                      return s

                  # ç®€åŒ–æ¶ˆæ¯å†…å®¹
                  msg = (
                      f'ğŸ”” æ–°å†…å®¹æé†’\n'
                      f'æ ‡é¢˜ï¼š{escape(entry["title"])[:30]}\n'
                      f'å‘å¸ƒæ—¶é—´ï¼š{entry["published"]}\n'
                      f'é“¾æ¥ï¼š{escape(entry["link"])}'
                  )
                  print(f'å¾…æ¨é€å†…å®¹ï¼š{msg[:50]}...')

                  # æ¨é€è¯·æ±‚ï¼ˆå…³é—­Markdownå…ˆæµ‹è¯•ï¼‰
                  api_url = f'https://api.safew.org/bot{config["SAFEW_BOT_TOKEN"]}/sendMessage'
                  params = {
                      'chat_id': config['SAFEW_CHAT_ID'],
                      'text': msg,
                      'parse_mode': 'None',  # å…ˆå…³é—­Markdown
                      'disable_web_page_preview': True
                  }
                  print(f'æ¨é€APIï¼š{api_url[:50]}...')
                  print(f'ç›®æ ‡ç¾¤ç»„IDï¼š{config["SAFEW_CHAT_ID"]}')

                  resp = requests.post(api_url, params=params, timeout=20)
                  print(f'æ¨é€å“åº”ç ï¼š{resp.status_code}')
                  print(f'å“åº”å†…å®¹ï¼š{resp.text[:200]}')
                  resp.raise_for_status()
                  print(f'âœ… æ¨é€æˆåŠŸ')
                  return True
              except Exception as e:
                  print(f'âŒ æ¨é€å¤±è´¥ï¼š')
                  traceback.print_exc()
                  return False

          def update_pushed_links(issue_id, new_links):
              """æ›´æ–°å·²æ¨é€è®°å½•"""
              if not issue_id or not new_links:
                  return
              try:
                  print(f"\n===== æ›´æ–°æ¨é€è®°å½• =====")
                  github_headers = {
                      'Authorization': f'token {config["RSS_GITHUB_PAT"]}',
                      'Accept': 'application/vnd.github.v3+json'
                  }
                  issue_url = f'https://api.github.com/repos/{config["GITHUB_REPO"]}/issues/{issue_id}'
                  resp = requests.get(issue_url, headers=github_headers, timeout=20)
                  resp.raise_for_status()

                  new_body = resp.json()['body'] + '\n'.join(new_links) + '\n'
                  update_resp = requests.patch(issue_url, headers=github_headers, json={'body': new_body}, timeout=20)
                  update_resp.raise_for_status()
                  print(f'âœ… è®°å½•æ›´æ–°æˆåŠŸï¼ˆæ–°å¢{len(new_links)}æ¡ï¼‰')
              except Exception as e:
                  print(f'âŒ è®°å½•æ›´æ–°å¤±è´¥ï¼š')
                  traceback.print_exc()

          # -------------------------- 3. ä¸»æµç¨‹ --------------------------
          def main():
              print("===== ç¨‹åºå¯åŠ¨ =====")
              # 1. è§£æRSS
              rss_entries = parse_rss()
              if not rss_entries:
                  print("===== æ— RSSæ¡ç›®ï¼Œé€€å‡º =====")
                  return

              # 2. è¯»å–å·²æ¨é€è®°å½•
              pushed_links, issue_id = get_pushed_links()
              if issue_id is None:
                  print("===== æ— æ³•è·å–è®°å½•ï¼Œé€€å‡º =====")
                  return

              # 3. ç­›é€‰æ–°å†…å®¹
              new_entries = [e for e in rss_entries if e['link'] not in pushed_links and e['link']]
              if not new_entries:
                  print("===== æ— æ–°å†…å®¹ï¼Œé€€å‡º =====")
                  return
              print(f'âœ… å¾…æ¨é€æ–°æ¡ç›®ï¼š{len(new_entries)}æ¡')

              # 4. æ¨é€æµ‹è¯•ï¼ˆåªæ¨1æ¡ï¼‰
              success_links = []
              for entry in new_entries[:1]:
                  if push_to_safew(entry):
                      success_links.append(entry['link'])

              # 5. æ›´æ–°è®°å½•
              if success_links:
                  update_pushed_links(issue_id, success_links)
              else:
                  print("â„¹ï¸ æ— æˆåŠŸæ¨é€é“¾æ¥ï¼Œä¸æ›´æ–°è®°å½•")

              print("===== ç¨‹åºæ­£å¸¸ç»“æŸ =====")

          # -------------------------- 4. æ‰§è¡Œå…¥å£ --------------------------
          if __name__ == '__main__':
              try:
                  main()
              except Exception as e:
                  print("âŒ ç¨‹åºå¼‚å¸¸é€€å‡ºï¼š")
                  traceback.print_exc()
                  exit(1)
          END
