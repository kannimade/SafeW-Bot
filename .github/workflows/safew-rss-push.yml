name: SafeW - RSSç›‘å¬+å»é‡æ¨é€
# è§¦å‘æ¡ä»¶ï¼š1.å®šæ—¶è§¦å‘ 2.æ‰‹åŠ¨è§¦å‘ï¼ˆä¾¿äºæµ‹è¯•ï¼‰
on:
  schedule:
    # å®šæ—¶è§„åˆ™ï¼šæ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ˆCronè¡¨è¾¾å¼ï¼ŒUTCæ—¶é—´ï¼Œæ¯”åŒ—äº¬æ—¶é—´æ™š8å°æ—¶ï¼‰
    # åŒ—äº¬æ—¶é—´æ¯10åˆ†é’Ÿï¼š0/10 * * * * â†’ UTCæ—¶é—´éœ€å‡8å°æ—¶ï¼Œå³ 16/10 * * * *
    - cron: '*/10 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  rss-push:
    runs-on: ubuntu-latest
    steps:
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          pip install --upgrade requests feedparser  # feedparserè§£æRSSï¼Œrequestsè°ƒç”¨API
      
      - name: æ‰§è¡ŒRSSç›‘å¬+å»é‡æ¨é€è„šæœ¬
        env:
          # 1. SafeWç›¸å…³å¯†é’¥ï¼ˆå·²é€‚é…ä½ çš„ä¿¡æ¯ï¼‰
          SAFEW_BOT_TOKEN: ${{ secrets.SAFEW_BOT_TOKEN }}
          SAFEW_CHAT_ID: ${{ secrets.SAFEW_CHAT_ID }}
          # 2. GitHubå»é‡å­˜å‚¨ç›¸å…³ï¼ˆéœ€åç»­é…ç½®ï¼‰
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
          GITHUB_REPO: ${{ github.repository }}  # è‡ªåŠ¨è·å–å½“å‰ä»“åº“ï¼ˆæ ¼å¼ï¼šç”¨æˆ·å/ä»“åº“åï¼‰
          STORE_ISSUE_TITLE: "å·²æ¨é€RSSé“¾æ¥è®°å½•"  # å­˜å‚¨å»é‡é“¾æ¥çš„Issueæ ‡é¢˜ï¼ˆå›ºå®šï¼‰
          # 3. éœ€è‡ªå®šä¹‰ï¼šä½ çš„RSSæºåœ°å€ï¼ˆæ›¿æ¢ä¸ºå®é™…è¦ç›‘å¬çš„RSSï¼‰
          RSS_FEED_URL: "https://example.com/rss.xml"
        run: |
          python -c "
          import os
          import requests
          import feedparser
          from datetime import datetime

          # -------------------------- 1. é…ç½®å‚æ•°è¯»å– --------------------------
          # SafeWé…ç½®
          safew_bot_token = os.getenv('SAFEW_BOT_TOKEN')
          safew_chat_id = os.getenv('SAFEW_CHAT_ID')
          # GitHubé…ç½®ï¼ˆå»é‡å­˜å‚¨ï¼‰
          github_pat = os.getenv('GITHUB_PAT')
          github_repo = os.getenv('GITHUB_REPO')
          store_issue_title = os.getenv('STORE_ISSUE_TITLE')
          # RSSé…ç½®
          rss_feed_url = os.getenv('RSS_FEED_URL')

          # GitHub APIè¯·æ±‚å¤´ï¼ˆå¸¦è®¤è¯ï¼‰
          github_headers = {
              'Authorization': f'token {github_pat}',
              'Accept': 'application/vnd.github.v3+json'
          }

          # -------------------------- 2. è§£æRSSæº --------------------------
          def parse_rss():
              \"\"\"è§£æRSSæºï¼Œè¿”å›æœ€æ–°æ¡ç›®åˆ—è¡¨ï¼ˆæŒ‰å‘å¸ƒæ—¶é—´å€’åºï¼‰\"\"\"
              try:
                  feed = feedparser.parse(rss_feed_url)
                  if feed.bozo != 0:  # RSSè§£æå¤±è´¥
                      print(f'âŒ RSSè§£æå¤±è´¥ï¼š{feed.bozo_exception}')
                      return []
                  # æå–å…³é”®ä¿¡æ¯ï¼šæ ‡é¢˜ã€é“¾æ¥ã€æ‘˜è¦ã€å‘å¸ƒæ—¶é—´
                  entries = []
                  for entry in feed.entries:
                      entry_data = {
                          'title': entry.get('title', 'æ— æ ‡é¢˜'),
                          'link': entry.get('link', ''),  # é“¾æ¥ä½œä¸ºå»é‡å”¯ä¸€æ ‡è¯†
                          'summary': entry.get('summary', 'æ— æ‘˜è¦')[:150] + '...' if len(entry.get('summary', '')) > 150 else entry.get('summary', 'æ— æ‘˜è¦'),
                          'published': entry.get('published', datetime.now().strftime('%Y-%m-%d %H:%M:%S'))
                      }
                      entries.append(entry_data)
                  print(f'âœ… æˆåŠŸè§£æRSSï¼Œå…±è·å–{len(entries)}æ¡æ¡ç›®')
                  return entries
              except Exception as e:
                  print(f'âŒ RSSè§£æå¼‚å¸¸ï¼š{str(e)}')
                  return []

          # -------------------------- 3. è¯»å–å·²æ¨é€é“¾æ¥ï¼ˆå»é‡åˆ—è¡¨ï¼‰ --------------------------
          def get_pushed_links():
              \"\"\"ä»GitHub Issuesä¸­è¯»å–å·²æ¨é€é“¾æ¥ï¼Œè¿”å›é“¾æ¥é›†åˆ\"\"\"
              # 1. æœç´¢å­˜å‚¨ç”¨çš„Issueï¼ˆæŒ‰æ ‡é¢˜åŒ¹é…ï¼‰
              search_url = f'https://api.github.com/search/issues?q=repo:{github_repo}+title:"{store_issue_title}"+state:open'
              response = requests.get(search_url, headers=github_headers)
              if response.status_code != 200:
                  print(f'âŒ æœç´¢å­˜å‚¨Issueå¤±è´¥ï¼š{response.text}')
                  return set()
              
              search_result = response.json()
              if search_result['total_count'] == 0:
                  # è‹¥ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€æ¡æ–°Issueä½œä¸ºå­˜å‚¨
                  create_url = f'https://api.github.com/repos/{github_repo}/issues'
                  create_data = {
                      'title': store_issue_title,
                      'body': '# å·²æ¨é€RSSé“¾æ¥è®°å½•\\n\\nä»¥ä¸‹ä¸ºå·²æ¨é€çš„RSSé“¾æ¥ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œç”¨äºå»é‡ï¼š\\n',
                      'labels': ['rss-store']  # æ ‡è®°ä¸ºå­˜å‚¨ç”¨Issue
                  }
                  create_resp = requests.post(create_url, headers=github_headers, json=create_data)
                  if create_resp.status_code == 201:
                      print(f'âœ… é¦–æ¬¡è¿è¡Œï¼Œåˆ›å»ºå­˜å‚¨IssueæˆåŠŸ')
                      return set()
                  else:
                      print(f'âŒ åˆ›å»ºå­˜å‚¨Issueå¤±è´¥ï¼š{create_resp.text}')
                      return set()
              
              # 2. è¯»å–å·²æœ‰Issueçš„å†…å®¹ï¼Œæå–é“¾æ¥
              store_issue_id = search_result['items'][0]['number']
              issue_url = f'https://api.github.com/repos/{github_repo}/issues/{store_issue_id}'
              issue_resp = requests.get(issue_url, headers=github_headers)
              if issue_resp.status_code != 200:
                  print(f'âŒ è·å–å­˜å‚¨Issueå†…å®¹å¤±è´¥ï¼š{issue_resp.text}')
                  return set()
              
              issue_body = issue_resp.json()['body']
              # æå–æ‰€æœ‰é“¾æ¥ï¼ˆæŒ‰è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤ç©ºè¡Œå’Œéé“¾æ¥è¡Œï¼‰
              pushed_links = set()
              for line in issue_body.split('\\n'):
                  line = line.strip()
                  if line.startswith('http'):
                      pushed_links.add(line)
              print(f'âœ… è¯»å–å·²æ¨é€é“¾æ¥ï¼Œå…±{len(pushed_links)}æ¡')
              return pushed_links, store_issue_id

          # -------------------------- 4. æ¨é€æ–°å†…å®¹è‡³SafeW --------------------------
          def push_to_safew(entry):
              \"\"\"è°ƒç”¨SafeW Botæ¨é€å•æ¡RSSæ¡ç›®\"\"\"
              message = f\"""
ğŸ”” RSSæ–°å†…å®¹æé†’
----------------
**æ ‡é¢˜**ï¼š{entry['title']}
**å‘å¸ƒæ—¶é—´**ï¼š{entry['published']}
**æ‘˜è¦**ï¼š{entry['summary']}
**æŸ¥çœ‹é“¾æ¥**ï¼š{entry['link']}
              \"""
              
              api_url = f'https://api.safew.org/bot{safew_bot_token}/sendMessage'
              params = {
                  'chat_id': safew_chat_id,
                  'text': message,
                  'parse_mode': 'Markdown',
                  'disable_web_page_preview': True
              }
              
              response = requests.post(api_url, params=params)
              if response.status_code == 200:
                  print(f'âœ… æ¨é€æˆåŠŸï¼š{entry["title"]}')
                  return True
              else:
                  print(f'âŒ æ¨é€å¤±è´¥ï¼š{entry["title"]}ï¼Œå“åº”ï¼š{response.text}')
                  return False

          # -------------------------- 5. æ›´æ–°å·²æ¨é€é“¾æ¥ï¼ˆè¿½åŠ åˆ°Issueï¼‰ --------------------------
          def update_pushed_links(store_issue_id, new_links):
              \"\"\"å°†æ–°æ¨é€çš„é“¾æ¥è¿½åŠ åˆ°å­˜å‚¨Issueä¸­\"\"\"
              if not new_links:
                  return
              
              # è·å–å½“å‰Issueå†…å®¹
              issue_url = f'https://api.github.com/repos/{github_repo}/issues/{store_issue_id}'
              issue_resp = requests.get(issue_url, headers=github_headers)
              if issue_resp.status_code != 200:
                  print(f'âŒ æ›´æ–°å­˜å‚¨å¤±è´¥ï¼šæ— æ³•è·å–Issueå†…å®¹')
                  return
              
              current_body = issue_resp.json()['body']
              # è¿½åŠ æ–°é“¾æ¥ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰
              new_links_text = '\\n'.join(new_links)
              updated_body = f'{current_body}\\n{new_links_text}'
              
              # æ›´æ–°Issue
              update_url = f'https://api.github.com/repos/{github_repo}/issues/{store_issue_id}'
              update_data = {'body': updated_body}
              update_resp = requests.patch(update_url, headers=github_headers, json=update_data)
              if update_resp.status_code == 200:
                  print(f'âœ… å·²æ›´æ–°å­˜å‚¨ï¼Œæ–°å¢{len(new_links)}æ¡é“¾æ¥')
              else:
                  print(f'âŒ æ›´æ–°å­˜å‚¨å¤±è´¥ï¼š{update_resp.text}')

          # -------------------------- ä¸»æµç¨‹æ‰§è¡Œ --------------------------
          def main():
              # 1. è§£æRSS
              rss_entries = parse_rss()
              if not rss_entries:
                  return
              
              # 2. è¯»å–å·²æ¨é€é“¾æ¥å’Œå­˜å‚¨Issue ID
              pushed_links, store_issue_id = get_pushed_links()
              
              # 3. ç­›é€‰æœªæ¨é€çš„æ¡ç›®ï¼ˆæŒ‰linkå»é‡ï¼‰
              new_entries = []
              for entry in rss_entries:
                  if entry['link'] not in pushed_links and entry['link'] != '':
                      new_entries.append(entry)
              if not new_entries:
                  print(f'â„¹ï¸  æ— æ–°å†…å®¹å¯æ¨é€ï¼Œç»“æŸæ‰§è¡Œ')
                  return
              print(f'âœ… ç­›é€‰å‡ºæœªæ¨é€æ¡ç›®ï¼š{len(new_entries)}æ¡')
              
              # 4. æ¨é€æ–°æ¡ç›®å¹¶æ”¶é›†æˆåŠŸçš„é“¾æ¥
              success_links = []
              for entry in new_entries[:5]:  # é™åˆ¶å•æ¬¡æœ€å¤šæ¨é€5æ¡ï¼Œé¿å…åˆ·å±
                  if push_to_safew(entry):
                      success_links.append(entry['link'])
              
              # 5. æ›´æ–°å·²æ¨é€é“¾æ¥å­˜å‚¨
              if success_links:
                  update_pushed_links(store_issue_id, success_links)

          if __name__ == '__main__':
              main()
          "
