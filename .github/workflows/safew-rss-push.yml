import feedparser
import logging
import asyncio
import json
import os
import aiohttp  # ç”¨äºå¼‚æ­¥HTTPè¯·æ±‚ï¼ˆæ›¿ä»£telegramåº“ï¼‰

# ä»ç¯å¢ƒå˜é‡è¯»å–SafeWé…ç½®ï¼ˆæ›¿æ¢åŸTelegramé…ç½®ï¼‰
SAFEW_BOT_TOKEN = os.getenv("SAFEW_BOT_TOKEN")
SAFEW_CHAT_ID = os.getenv("SAFEW_CHAT_ID")
RSS_FEED_URL = os.getenv("RSS_FEED_URL")

# å­˜å‚¨å·²å‘é€é“¾æ¥çš„æœ¬åœ°æ–‡ä»¶ï¼ˆæ³¨æ„ï¼šGitHub Actionsä¸­éœ€æ”¹ç”¨æŒä¹…åŒ–å­˜å‚¨ï¼Œå¦‚Issuesï¼‰
SENT_LINKS_FILE = "sent_links.json"

# é…ç½®æ—¥å¿—
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# è¯»å–å·²å‘é€çš„é“¾æ¥ï¼ˆå»é‡ä¾æ®ï¼‰
def load_sent_links():
    try:
        if os.path.exists(SENT_LINKS_FILE):
            with open(SENT_LINKS_FILE, "r", encoding="utf-8") as f:
                content = f.read().strip()
                return json.loads(content) if content else []
        logging.info("é¦–æ¬¡è¿è¡Œï¼Œåˆ›å»ºç©ºé“¾æ¥åˆ—è¡¨")
        return []
    except Exception as e:
        logging.error(f"è¯»å–å·²å‘é€é“¾æ¥å¤±è´¥ï¼š{str(e)}")
        return []

# ä¿å­˜å·²å‘é€çš„é“¾æ¥
def save_sent_links(links):
    try:
        with open(SENT_LINKS_FILE, "w", encoding="utf-8") as f:
            json.dump(links, f, ensure_ascii=False, indent=2)
        logging.info(f"å·²ä¿å­˜é“¾æ¥åˆ—è¡¨ï¼ˆå…±{len(links)}æ¡ï¼‰")
    except Exception as e:
        logging.error(f"ä¿å­˜å·²å‘é€é“¾æ¥å¤±è´¥ï¼š{str(e)}")

# è·å–RSSæ›´æ–°
def fetch_rss_updates():
    try:
        logging.info(f"è·å–RSSæºï¼š{RSS_FEED_URL}")
        feed = feedparser.parse(RSS_FEED_URL)
        if feed.bozo:
            logging.error(f"RSSè§£æé”™è¯¯ï¼š{feed.bozo_exception}")
            return None
        logging.info(f"æˆåŠŸè·å–{len(feed.entries)}æ¡RSSæ¡ç›®")
        return feed
    except Exception as e:
        logging.error(f"è·å–RSSå¤±è´¥ï¼š{str(e)}")
        return None

# è½¬ä¹‰Markdownç‰¹æ®Šå­—ç¬¦ï¼ˆé€‚é…SafeWçš„æ ¼å¼è¦æ±‚ï¼‰
def escape_markdown(text):
    special_chars = r"_*~`>#+-.!()"
    for char in special_chars:
        text = text.replace(char, f"\{char}")
    return text

# å‘é€å•æ¡æ¶ˆæ¯åˆ°SafeWï¼ˆå¼‚æ­¥è¯·æ±‚ï¼‰
async def send_to_safew(session, title, link, delay=3):
    try:
        # å‘é€å‰ç­‰å¾…æŒ‡å®šç§’æ•°ï¼ˆé¿å…é¢‘ç‡é™åˆ¶ï¼‰
        await asyncio.sleep(delay)
        
        # æ„é€ æ¶ˆæ¯å†…å®¹ï¼ˆç®€åŒ–æ ¼å¼ï¼Œé¿å…å¤æ‚è§£æï¼‰
        escaped_title = escape_markdown(title)
        escaped_link = escape_markdown(link)
        message = f"ğŸ”” æ–°å†…å®¹æé†’\n\næ ‡é¢˜ï¼š{escaped_title}\né“¾æ¥ï¼š{escaped_link}"
        logging.info(f"å‡†å¤‡å‘é€ï¼š{message[:50]}...")
        
        # SafeW APIåœ°å€ï¼ˆæ ¹æ®å®é™…æ¥å£è°ƒæ•´ï¼‰
        api_url = f"https://api.safew.org/bot{SAFEW_BOT_TOKEN}/sendMessage"
        params = {
            "chat_id": SAFEW_CHAT_ID,
            "text": message,
            "parse_mode": "Markdown",  # æŒ‰SafeWæ”¯æŒçš„æ ¼å¼è°ƒæ•´
            "disable_web_page_preview": True
        }
        
        # å‘é€å¼‚æ­¥POSTè¯·æ±‚
        async with session.get(api_url, params=params) as response:
            response_text = await response.text()
            logging.info(f"SafeWå“åº”ï¼šçŠ¶æ€ç ={response.status}ï¼Œå†…å®¹={response_text[:200]}")
            
            if response.status == 200:
                logging.info("æ¶ˆæ¯å‘é€æˆåŠŸ")
                return True
            else:
                logging.error(f"å‘é€å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š{response.status}ï¼‰")
                return False
    
    except Exception as e:
        logging.error(f"å‘é€è¿‡ç¨‹å¼‚å¸¸ï¼š{str(e)}")
        return False

# æ£€æŸ¥æ›´æ–°å¹¶æ¨é€æ–°å†…å®¹
async def check_and_push(sent_links):
    rss_feed = fetch_rss_updates()
    if not rss_feed:
        return
    
    new_entries = []
    for entry in rss_feed.entries:
        entry_link = entry.get("link", "")
        if not entry_link:
            logging.warning("è·³è¿‡æ— é“¾æ¥çš„æ¡ç›®")
            continue
        
        # å»é‡é€»è¾‘ï¼ˆåŸºäºé“¾æ¥ï¼‰
        if entry_link not in sent_links:
            new_entries.append({
                "title": entry.get("title", "æ— æ ‡é¢˜"),
                "link": entry_link
            })
    
    if new_entries:
        logging.info(f"å‘ç°{len(new_entries)}æ¡æ–°å†…å®¹ï¼Œå‡†å¤‡æ¨é€ï¼ˆé—´éš”{3}ç§’ï¼‰")
        
        # å¼‚æ­¥å‘é€æ‰€æœ‰æ–°å†…å®¹
        async with aiohttp.ClientSession() as session:
            success_links = []
            for i, entry in enumerate(new_entries):
                # ç¬¬ä¸€æ¡ç«‹å³å‘é€ï¼Œåç»­æ¯æ¡é—´éš”3ç§’
                delay = 3 if i > 0 else 0
                success = await send_to_safew(
                    session,
                    title=entry["title"],
                    link=entry["link"],
                    delay=delay
                )
                if success:
                    success_links.append(entry["link"])
        
        # ä¿å­˜æˆåŠŸæ¨é€çš„é“¾æ¥ï¼ˆç”¨äºå»é‡ï¼‰
        if success_links:
            sent_links.extend(success_links)
            save_sent_links(sent_links)
    else:
        logging.info("æ— æ–°å†…å®¹éœ€è¦æ¨é€")

# ä¸»å‡½æ•°
async def main():
    logging.info("===== SafeW RSSæ¨é€è„šæœ¬å¯åŠ¨ =====")
    
    # æ ¡éªŒå¿…è¦é…ç½®
    if not all([SAFEW_BOT_TOKEN, SAFEW_CHAT_ID, RSS_FEED_URL]):
        logging.error("é”™è¯¯ï¼šç¼ºå¤±å¿…è¦ç¯å¢ƒå˜é‡ï¼ˆSAFEW_BOT_TOKEN/SAFEW_CHAT_ID/RSS_FEED_URLï¼‰")
        return
    
    # åŠ è½½å·²å‘é€é“¾æ¥
    sent_links = load_sent_links()
    
    try:
        await check_and_push(sent_links)
    except Exception as e:
        logging.error(f"ä¸»é€»è¾‘æ‰§è¡Œå¤±è´¥ï¼š{str(e)}")
    
    logging.info("===== è„šæœ¬è¿è¡Œç»“æŸ =====")

if __name__ == "__main__":
    asyncio.run(main())
